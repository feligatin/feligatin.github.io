@model CertificadoAcreenciaWeb.Models.ProveedorDataModel
@using CertificadoAcreenciaWeb.Models;
@{
    ViewBag.Title = "Home Page";
    List<SelectListItem> lsTipoProveedor = new List<SelectListItem>();
    if (ViewBag.ListaTipoProveedor != null)
    {
        lsTipoProveedor = ViewBag.ListaTipoProveedor;



    }

}
<style>
    body {
        margin-top: 70px;
    }

    .stepwizard-step p {
        margin-top: 10px;
    }

    .stepwizard-row {
        display: table-row;
    }

    .stepwizard {
        display: table;
        width: 50%;
        position: relative;
    }

        .stepwizard .btn.disabled, .stepwizard .btn[disabled], .stepwizard fieldset[disabled] .btn {
            opacity: 1 !important;
            color: #bbb;
        }

    .stepwizard-step button[disabled] {
        opacity: 1 !important;
        filter: alpha(opacity=100) !important;
    }

    .stepwizard-row:before {
        top: 14px;
        bottom: 0;
        position: absolute;
        content: " ";
        width: 100%;
        height: 1px;
        background-color: #ccc;
        /*z-order: 0;*/
    }

    .stepwizard-step {
        display: table-cell;
        text-align: center;
        position: relative;
    }

    .btn-circle {
        width: 30px;
        height: 30px;
        text-align: center;
        padding: 6px 0;
        font-size: 12px;
        line-height: 1.428571429;
        border-radius: 15px;
    }
    #fecha {
        display: none;
    }   
</style>


<div class="row">
    <div class="container">
        <div class="stepwizard col-md-offset-3">
            <div class="stepwizard-row setup-panel">
                <div class="stepwizard-step">
                    <a href="#step-1" type="button" id="step1" class="btn btn-primary btn-circle">1</a>
                    <p>Datos Proveedor</p>
                </div>
                <div class="stepwizard-step">
                    <a href="#step-2" type="button" id="step2" class="btn btn-default btn-circle" disabled="disabled">2</a>
                    <p>Ingreso Facturas</p>
                </div>
                <div class="stepwizard-step">
                    <a href="#step-3" type="button" id="step3" class="btn btn-default btn-circle" disabled="disabled">3</a>
                    <p>Resumén Datos</p>
                </div>
            </div>
        </div>
        @using (Html.BeginForm("Index", "Home", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            <div class="row setup-content" id="step-1">

                <div class="col-xs-8 col-md-offset-2">
                    <div class="col-md-12">
                        <h3> Información del Proveedor</h3>
                        <div class="form-horizontal">
                            <div class="body-content">
                                <hr />
                                <div class="form-group">
                                    <label for="inputTipoProveedor" class="col-sm-3 control-label">Tipo Proveedor</label>
                                    <div class="col-sm-9">
                                        @Html.DropDownListFor(x => x.TipoProveedor, lsTipoProveedor, new { @class = "form-control input-sm", onchange = "DesabilitaPantallaProveedor();BuscarMes(this)" })
                                    </div>
                                </div>
                              
                               
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">RUC / Cédula</label>
                                    <div class="col-sm-9">

                                        @Html.TextBoxFor(x => x.Ruc, new { @class = "form-control", @id = "idRuc", required = "required", placeholder = "1700000000001", onchange = "BuscarProveedor(this),BuscarProveedor2(this)" })
                                        <img src="~/Content/images/tenor.gif" style="display:none;width:500px;" id="loading" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">Razón Social</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.NombreProveedor, new { @class = "form-control", @id = "nombreProveedor", required = "required" })
                                        @Html.ValidationMessageFor(x => x.Ruc, null, new { @class = " text-danger" })
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputemail" class="col-sm-3 control-label">Email</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Email, new { @class = "form-control", @id = "Correo", autofocus = "autofocus" })
                                        @Html.ValidationMessageFor(x => x.Email, null, new { @class = " text-danger" })
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputTelefono" class="col-sm-3 control-label">Télefono</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Telefono1, new { @class = "form-control", @id = "inputTelefono", required = "required", placeholder = "293-022393-253" })
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputCelular" class="col-sm-3 control-label">Celular</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Celular, new { @class = "form-control", @id = "inputCelular", required = "required", placeholder = "0999999999" })
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputDireccion" class="col-sm-3 control-label">Dirección</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Direccion, new { @class = "form-control", @id = "inputDireccion", required = "required" })
                                    </div>
                                </div>
                                <div id="fecha">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">Fecha</label>
                                        <div class="col-sm-9">
                                            <input id="mes" type="date" name="fecha" onchange="BuscarHora(this)" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">Horario</label>
                                        <div class="col-sm-9">
                                            <select name="idhorario" id="idhorario">
                                                <option>==Seleccionar horario==</option>

                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary nextBtn btn-lg pull-right" id="btn_proveedor" type="button" onclick="reagendar()">Siguiente</button>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row setup-content" id="step-2">
                <div class="col-xs-8 col-md-offset-3">
                    <div class="col-md-12">
                        <h3> Ingreso Facturas</h3>
                        <hr />
                        <div class="body-content">

                            <div class="row">

                                <div class="form-group">
                                    <div class="col-xs-3">
                                        <label class="control-label">No. FACTURA</label>
                                    </div>

                                    <div class="col-xs-4">
                                        <label class="control-label">DETALLE</label>
                                    </div>


                                    <div class="col-xs-3">
                                        <label class="control-label">VALOR</label>
                                    </div>
                                </div>


                                <div class="form-group">
                                    <div class="col-xs-3">
                                        <input type="text" id="inputFactura" name="inputFactura" class="form-control" placeholder="0000000000" />
                                    </div>

                                    <div class="col-xs-4">
                                        <input type="text" id="inputDetalle" name="inputDetalle" class="form-control" />
                                    </div>


                                    <div class="col-xs-3">
                                        <input type="text" id="inputValor" name="inputValor" class="form-control" />
                                    </div>

                                    <div class="col-xs-1 text-justify">
                                        <input value="Agregar" type="button" class="btn btn-default" onclick="productAddToTable(); return false;" />
                                    </div>
                                </div>
                            </div>
                            <br />
                            <div id="divConceptos">
                                <table id="tablaConceptos" class="table table-bordered table-condensed table-striped" style="width:100%;">
                                    <tr>
                                        <th>Factura</th>
                                        <th>Detalle</th>
                                        <th>Total</th>
                                        <th>Eliminar</th>
                                    </tr>
                                </table>
                            </div>
                            <button id="btnFacturas" class="btn btn-primary nextBtn btn-lg pull-right" type="button">Siguiente</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row setup-content" id="step-3">
                <div class="col-xs-6 col-md-offset-3">
                    <div class="col-md-12">
                        <h3> Resumen de las Facturas</h3>
                        <hr />
                        <div class="panel-body">
                            <div id="ResumenProveedor" class="control-label"></div>
                        </div>
                      <form action="Resumen" method="post">
                          <input type="submit" name="enviar" value="Enviar"/>
                      </form>
                        <div id="agendamiento2">
                            <button href="@Url.Action("Print","Resumen")" id="btn_Grabar" class="btn btn-success btn-lg pull-right" type="button">Grabar</button>
                        </div>
                        <div id="agendamiento2">
                            <a href="@Url.Action("Resumen.cshtml","Home")" class="btn btn-success btn-lg pull-right" type="button">Convertir a Pdf</a>
                        </div>

                        <div id="agendamiento">
                            <input type="button" class="btn btn-success btn-lg pull-right" value="ReAgendar" id="btn_Reagendar" />
                        </div>
                    </div>
                </div>
            </div>

        }
    </div>
</div>
@section Scripts {
    <script>


        $(document).ready(function () {
            DesabilitaPantallaProveedor();
            $('#inputValor').numeric(",");

            var navListItems = $('div.setup-panel div a'),
                allWells = $('.setup-content'),
                allNextBtn = $('.nextBtn');

            allWells.hide();

            navListItems.click(function (e) {
                e.preventDefault();
                var $target = $($(this).attr('href')),
                    $item = $(this);

                if (!$item.hasClass('disabled')) {
                    navListItems.removeClass('btn-primary').addClass('btn-default');
                    $item.addClass('btn-primary');
                    allWells.hide();
                    $target.show();
                    $target.find('input:eq(0)').focus();
                }
            });

            allNextBtn.click(function () {
                var curStep = $(this).closest(".setup-content"),
                    curStepBtn = curStep.attr("id"),
                    nextStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().next().children("a"),
                    curInputs = curStep.find("input[type='text'],input[type='url']"),
                    isValid = true;

                $(".form-group").removeClass("has-error");
                for (var i = 0; i < curInputs.length; i++) {
                    if (!curInputs[i].validity.valid) {
                        isValid = false;
                        $(curInputs[i]).closest(".form-group").addClass("has-error");
                    }
                }

                if (isValid)
                    nextStepWizard.removeAttr('disabled').trigger('click');
            });

            $('div.setup-panel div a.btn-primary').trigger('click');

            $('#btn_proveedor').click(function () {

                var email = $("#Correo").val();
                var expr = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
                if (!expr.test(email)) {
                    alert('Email es incorrecto')
                };
            });


            $('#btn_Grabar').click(function () {
                var DetalleIDArray = [];
                var _tipoProveedor = $("#TipoProveedor").val();
                var _ruc = $("#idRuc").val();
                var _nombreProveedor =$("#nombreProveedor").val();
                var _correo =$("#Correo").val();
                var _telefono =$("#inputTelefono").val();
                var _celular =$("#inputCelular").val();
                var _direccion = $("#inputDireccion").val();
                var _mes = $("#mes").val();
                var _hora = $("#idhorario").val();
                if (_tipoProveedor == '1') {

                    _tipo="N";
                }

                if (_tipoProveedor == '2') {
                    _tipo = "I";
                }
                if (_tipoProveedor == '3') {

                    _tipo = "N";
                }
                if (_tipoProveedor == '4') {
                    _tipo = "I";
                }




                $('#tablaConceptos tr').each(function () {
                    var _numFactura = $(this).find('td').eq(0).html();
                    if (_numFactura) {
                        DetalleIDArray.push({
                            "NumeroFactura": $(this).find('td').eq(0).html(), "DetalleFactura": $(this).find('td').eq(1).html(), "ValorFactura": $(this).find('td').eq(2).html()
                        });
                    }

                });

                var jsonProveedor = {
                    "IdProveedor": 0, "TipoProveedor": _tipoProveedor, "Ruc": _ruc, "NombreProveedor": _nombreProveedor, "Email": _correo, "Telefono1": _telefono, "Celular": _celular, "Direccion": _direccion, "mes": _mes, "Hora": _hora, "TipoCliente": _tipo, "DetalleFactura": DetalleIDArray
                };

                $.ajax({
                            url: '@Url.Action("GrabarProveedor", "Home")',
                            type: "POST",
                            contentType: "application/json;charset=UTF-8",
                            dataType: "json",
                            data: JSON.stringify(jsonProveedor),
                            success: function (result) {
                                if (result == "OK") {
                                    var _tipoProveedor = $("#TipoProveedor").val();
                                    var _nombreProveedor = $("#nombreProveedor").val();
                                    window.location.href = '@Url.Action("Resumen", "Home")?valor=' + _tipoProveedor + '&valor2=' + _nombreProveedor;


}
                                else {
                                                alert("No");
                                            }
                                        },
                            error: function (errormessage) {
                                            alert(errormessage);
                                        }

                                    });

            });


            $('#btnFacturas').click(function () {

                var _tipoProveedor = $("#TipoProveedor").val();
                var _ruc = $("#idRuc").val();
                var _nombreProveedor = $("#nombreProveedor").val();
                var _correo = $("#Correo").val();
                var _telefono = $("#inputTelefono").val();
                var _celular = $("#inputCelular").val();
                var _direccion = $("#inputDireccion").val();
                document.getElementById("ResumenProveedor").innerHTML = "<p>Estimado/a: </p> <p>" + _nombreProveedor + " </p> <p>PRESENTE </p> </p> <p align='justify'>Por medio de la presente, le comunico que la información ingresada se procederá a guardar y se le enviara a su correo la fecha y hora para que se acerque a la oficina de TAME EP (EN LIQUIDACIÓN), para su respectiva recepción de la documentación.</p>";
            });
        });


        function DesabilitaPantallaProveedor() {
            var _tipoProveedor = $("#TipoProveedor").val();
            if (_tipoProveedor == '0') {
                $("#idRuc").attr('readonly', true);
                $("#nombreProveedor").attr('readonly', true);
                $("#Correo").attr('readonly', true);
                $("#inputTelefono").attr('readonly', true);
                $("#inputCelular").attr('readonly', true);
                $("#inputDireccion").attr('readonly', true);
                $('#btn_proveedor').prop('disabled', true);
                $('#step2').prop('disabled', true);
            }
            else {
                $("#idRuc").attr('readonly', false);
                $("#nombreProveedor").attr('readonly', false);
                $("#Correo").attr('readonly', false);
                $("#inputTelefono").attr('readonly', false);
                $("#inputCelular").attr('readonly', false);
                $("#inputDireccion").attr('readonly', false);
                $('#btn_proveedor').prop('disabled', false);
                
            }
            if (_tipoProveedor == '1') {
                
                $("#fecha").show();
            }

            if (_tipoProveedor == '2') {
                $("#fecha").hide();
            }
            if (_tipoProveedor == '3') {
               
                $("#fecha").show();
            }
            if (_tipoProveedor == '4') {
                $("#fecha").hide();
            }

            document.getElementById("idRuc").value = "";
            document.getElementById("nombreProveedor").value = "";
            document.getElementById("Correo").value = "";
            document.getElementById("inputTelefono").value = "";
            document.getElementById("inputCelular").value = "";
            document.getElementById("inputDireccion").value = "";

        };

        var num = 0;
        function AgregaConcepto() {
            let Factura = document.getElementById("inputFactura").value;
            let Detalle = document.getElementById("inputDetalle").value;
            let Total = document.getElementById("inputValor").value;

            //agregamos tabla
            let Tabla = document.getElementById("tablaConceptos");
            let TR = document.createElement("tr");
            let TDFactura = document.createElement("td");
            let TDDetalle = document.createElement("td");
            let TDTotal = document.createElement("td");
            let TDBoton = document.createElement("td");
            TR.appendChild(TDFactura);
            TR.appendChild(TDDetalle);
            TR.appendChild(TDTotal);
            TDFactura.innerHTML = Factura;
            TDDetalle.innerHTML = Detalle;
            TDTotal.innerHTML = Total;
            TDTotal.innerHTML = Total;
            Tabla.appendChild(TR);



            document.getElementById("inputFactura").value = "";
            document.getElementById("inputDetalle").value = "";
            document.getElementById("inputValor").value = "";

            num++;
        }

        function productAddToTable() {


            // First check if a <tbody> tag exists, add one if not
            if ($("#tablaConceptos tbody").length == 0) {
                $("#tablaConceptos").append("<tbody></tbody>");
            }

            // Append product to the table
            $("#tablaConceptos tbody").append(
                "<tr>" +
                "<td>" + $("#inputFactura").val() + "</td>" +
                "<td>" + $("#inputDetalle").val() + "</td>" +
                "<td>" + $("#inputValor").val() + "</td>" +
                "<td>" +
                "<button type='button' onclick='facturaDelete(this);' class='btn btn-default'>" +
                "<span class='glyphicon glyphicon-remove' />" +
                "</button>" +
                "</td>" +
                "</tr>");
            //Limpia campos
            document.getElementById("inputFactura").value = "";
            document.getElementById("inputDetalle").value = "";
            document.getElementById("inputValor").value = "";

        }

        //Elimina el registro ingresado
        function facturaDelete(ctl) {
            $(ctl).parents("tr").remove();
        }



        //Busca proveedor
         function BuscarProveedor(inputObject) {
            var rucProveedor = inputObject.value;
            $.ajax({
                url: '@Url.Action("BuscaProveedor", "Home")',
                type: "GET",

                contentType: "application/json;charset=UTF-8",
                dataType: "json",
                data: { ruc: rucProveedor },
                success: function (result) {
                   /* $("#loading").show();*/
                    if (result.length > 0) {
                        if (result.length >= 1) {
                            $.each(result, function (index, data) {
                                $("#idRuc").val(data.Ruc);
                                $("#nombreProveedor").val(data.NombreProveedor);
                                $("#Correo").val(data.Email);
                                $("#inputTelefono").val(data.Telefono1);
                                $("#inputCelular").val(data.Celular);
                                $("#inputDireccion").val(data.Direccion);

                            });
                        }
                    }
                },
                error: function (errormessage) {
                    //mesajeActiva(errormessage.responseText);
                }
             });

        }
             function BuscarProveedor2(inputObject) {
            var rucProveedor = inputObject.value;
            $.ajax({
                url: '@Url.Action("BuscaProveedor", "Home")',
                type: "GET",

                contentType: "application/json;charset=UTF-8",
                dataType: "json",
                data: { ruc: rucProveedor },

                success: function (result) {

                    if (result.length > 0) {
                        if (result.length >= 1) {

                            $.each(result, function (index, data) {
                                $("#idRuc").val(data.Ruc);
                                $("#nombreProveedor").val(data.NombreProveedor);
                                $("#Correo").val(data.Email);
                                $("#inputTelefono").val(data.Telefono1);
                                $("#inputCelular").val(data.Celular);
                                $("#inputDireccion").val(data.Direccion);
                                $("#agendamiento").show();
                                $("#agendamiento2").hide();
                               /* $("#loading").hide();*/
                            });
                        }
                    }
                },
                error: function (errormessage) {
                    //mesajeActiva(errormessage.responseText);
                }
            });

        }
        
            
        function BuscarHora(inputObject) {
            var _mes = inputObject.value;
            $('#idhorario').empty();
            $.ajax({
                url: '@Url.Action("BuscaMes", "Home")',
                type: "GET",
                contentType: "application/json;charset=UTF-8",
                dataType: "json",
                data: { mes: _mes },
                success: function (result) {
                    
                    if (result.length > 0) {

                        if (result.length >= 1) {
    
                            $.each(result, function (index, data) {
                                
                                var select = document.getElementsByName("idhorario")[0];
                                
                                var option = document.createElement("option");

                               
                                option.text = data.Hora;
                                select.add(option);
                                
                            });
                        }
                    }
                },
                error: function (errormessage) {
                    //mesajeActiva(errormessage.responseText);
                }
            });

    }
    $(document).ready(function () {

        // Todo el código aquí.


    });




    </script>
}